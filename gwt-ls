#!/usr/bin/env bash
#
# gwt-ls - List all worktrees for the current repository
#
# Usage: gwt ls

set -e

# Colors
if [[ -t 1 ]]; then
    RED=$'\033[0;31m'
    GREEN=$'\033[0;32m'
    YELLOW=$'\033[0;33m'
    BLUE=$'\033[0;34m'
    CYAN=$'\033[0;36m'
    BOLD=$'\033[1m'
    DIM=$'\033[2m'
    NC=$'\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' BOLD='' DIM='' NC=''
fi

show_usage() {
    cat <<EOF
${BOLD}gwt ls${NC} - List all worktrees

${BOLD}USAGE${NC}
    gwt ls

${BOLD}OUTPUT${NC}
    Shows all worktrees for the current repository with:
    - Branch name
    - Path
    - Whether it's an ephemeral (agent) worktree

EOF
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_usage
    exit 0
fi

# Ensure we're in a git repo
if ! git rev-parse --git-dir &>/dev/null; then
    echo -e "${RED}error:${NC} not a git repository" >&2
    exit 1
fi

# Configuration
ephemeral_dir="${GWT_WORKTREE_DIR:-$HOME/.worktrees}"

# Get current worktree path (may be empty if at project root)
current_wt=$(git rev-parse --show-toplevel 2>/dev/null || echo "")

# Parse worktree list
worktrees=$(git worktree list --porcelain)

count=0
echo ""
echo -e "${BOLD}Worktrees${NC}"
echo ""

while IFS= read -r line; do
    if [[ "$line" =~ ^worktree\ (.+)$ ]]; then
        wt_path="${BASH_REMATCH[1]}"
    elif [[ "$line" =~ ^HEAD\ (.+)$ ]]; then
        wt_head="${BASH_REMATCH[1]:0:7}"
    elif [[ "$line" =~ ^branch\ refs/heads/(.+)$ ]]; then
        wt_branch="${BASH_REMATCH[1]}"
    elif [[ "$line" =~ ^detached$ ]]; then
        wt_branch="(detached)"
    elif [[ -z "$line" ]]; then
        # End of worktree entry, print it
        if [[ -n "$wt_path" ]]; then
            count=$((count + 1))

            # Determine type
            if [[ "$wt_path" == "$ephemeral_dir"* ]]; then
                type_label="${YELLOW}agent${NC}"
            elif [[ "$wt_path" == *".git" ]] || [[ -f "$wt_path/HEAD" && ! -d "$wt_path/.git" ]]; then
                type_label="${DIM}bare${NC}"
            else
                type_label="${BLUE}local${NC}"
            fi

            # Current indicator
            if [[ "$wt_path" == "$current_wt" ]]; then
                current_marker="${GREEN}*${NC} "
            else
                current_marker="  "
            fi

            # Branch display
            if [[ "$wt_branch" == "(detached)" ]]; then
                branch_display="${DIM}${wt_branch}${NC}"
            else
                branch_display="${CYAN}${wt_branch}${NC}"
            fi

            echo -e "${current_marker}${branch_display}"
            echo -e "    ${DIM}${wt_path}${NC}  [${type_label}]"
            echo ""
        fi

        # Reset for next entry
        wt_path="" wt_head="" wt_branch=""
    fi
done <<< "$worktrees"

# Handle last entry if file doesn't end with newline
if [[ -n "$wt_path" ]]; then
    count=$((count + 1))

    if [[ "$wt_path" == "$ephemeral_dir"* ]]; then
        type_label="${YELLOW}agent${NC}"
    else
        type_label="${BLUE}local${NC}"
    fi

    if [[ "$wt_path" == "$current_wt" ]]; then
        current_marker="${GREEN}*${NC} "
    else
        current_marker="  "
    fi

    if [[ "$wt_branch" == "(detached)" ]]; then
        branch_display="${DIM}${wt_branch}${NC}"
    else
        branch_display="${CYAN}${wt_branch}${NC}"
    fi

    echo -e "${current_marker}${branch_display}"
    echo -e "    ${DIM}${wt_path}${NC}  [${type_label}]"
    echo ""
fi

echo -e "${DIM}$count worktree(s) total${NC}"
